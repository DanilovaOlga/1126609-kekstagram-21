(()=>{"use strict";(()=>{const e="Escape",t="ArrowLeft",o="ArrowRight";window.helpers={getRandomIndex:e=>Math.floor(Math.random()*e.length),ESC:e,LEFT:t,RIGHT:o}})(),window.backend={request:e=>{const t=new XMLHttpRequest;t.responseType="json",t.addEventListener("load",(()=>{let o;switch(t.status){case 200:e.onSuccess(t.response);break;case 400:o="Неверный запрос";break;case 401:o="Пользователь не авторизован";break;case 404:o="Ничего не найдено";break;default:o=`Cтатус ответа: ${t.status} ${t.statusText}`}o&&e.onError(o)})),t.addEventListener("error",(()=>{e.onError("Произошла ошибка соединения")})),t.addEventListener("timeout",(()=>{e.onError(`Запрос не успел выполниться за ${t.timeout} мс`)})),t.timeout=1e4,t.open(e.method,e.url),t.send(e.data)}},(()=>{const e=/^#[a-zA-Z0-9]+$/,t=t=>t.indexOf("#",1)>=1?"Хэштеги разделяются пробелами":t.length<2?"Хэштег не может состоять только из одной решётки":e.test(t)?t.length>20?"Длина хэштега не должна превышать 20 символов":"":"Хэштег должен начинаться с символа # и состоять только из букв и цифр";window.hashtagsValidity={check:e=>{if(!(e=e.toLowerCase().trim()))return"";let o=e.split(/\s+/);if(o.length>5)return"Количество хэштегов не должно быть больше 5";for(let e=0;e<o.length;e++){let n=o[e];for(let t=e+1;t<o.length;t++)if(n===o[t])return"Такой хэштег уже есть";const r=t(n);if(r)return r}return""}}})(),window.commentValidity={check:e=>e.length>140?"Длина комментария не может составлять больше 140 символов":""},(()=>{const e=document.querySelector(".img-filters"),t=e.querySelectorAll(".img-filters__button"),o=e.querySelector("#filter-default"),n=e.querySelector("#filter-random"),r=e.querySelector("#filter-discussed"),s=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}};window.filters={init:(l,c)=>{e.classList.remove("img-filters--inactive");const i=s((()=>{l(c)})),a=s((()=>{l((e=>{e=e.slice();const t=[];for(let o=0;o<10;o++){let o=window.helpers.getRandomIndex(e);t.push(e[o]),e.splice(o,1)}return t})(c))})),d=s((()=>{l((e=>((e=e.slice()).sort(((e,t)=>{let o=e.comments.length,n=t.comments.length;return o>n?-1:o===n?0:1})),e))(c))}));t.forEach((e=>{e.addEventListener("click",(s=>{switch(s.preventDefault(),t.forEach((e=>{e.classList.remove("img-filters__button--active")})),e.classList.add("img-filters__button--active"),e){case o:i();break;case n:a();break;case r:d()}}))}))}}})(),(()=>{const e=document.querySelector(".pictures"),t=document.querySelector("#picture").content.querySelector(".picture");window.gallery={render:o=>{const n=document.createDocumentFragment();document.querySelectorAll(".picture").forEach((t=>{e.removeChild(t)})),o.forEach((e=>{n.appendChild((e=>{const o=t.cloneNode(!0);return o.querySelector(".picture__img").src=e.url,o.querySelector(".picture__likes").textContent=e.likes,o.querySelector(".picture__comments").textContent=e.comments.length,o.addEventListener("click",(t=>{t.preventDefault(),window.preview.show(e)})),o})(e))})),e.appendChild(n)}}})(),(()=>{const e=document.querySelector(".big-picture"),t=e.querySelector(".big-picture__social"),o=t.querySelector(".social__comments"),n=t.querySelector(".social__comment"),r=t.querySelector(".social__comments-loader"),s=t.querySelector(".social__comment-count");let l,c,i=0;const a=e=>{e.forEach((e=>{n.querySelector(".social__picture").src=e.avatar,n.querySelector(".social__picture").alt=e.name,n.querySelector(".social__text").textContent=e.message,o.appendChild(n.cloneNode(!0))})),i=o.children.length,s.textContent=`${i} из ${l} комментариев`,i===c.comments.length&&r.classList.add("hidden")};r.addEventListener("click",(e=>{e.preventDefault(),a(c.comments.slice(i,i+5))}));const d=()=>{window.main.body.classList.remove("modal-open"),e.classList.add("hidden"),window.removeEventListener("keydown",u)},u=e=>{e.key===window.helpers.ESC&&(e.preventDefault(),d())};e.querySelector(".big-picture__cancel").addEventListener("click",(e=>{e.preventDefault(),d()})),window.preview={show:n=>{var s;window.main.body.classList.add("modal-open"),e.classList.remove("hidden"),r.classList.remove("hidden"),c=s=n,e.querySelector(".big-picture__img img").src=s.url,t.querySelector(".likes-count").textContent=s.likes,t.querySelector(".social__caption").textContent=s.description,l=s.comments.length,Array.from(o.children).forEach((e=>{o.removeChild(e)})),a(s.comments.slice(0,5)),window.addEventListener("keydown",u)}}})(),(()=>{const e=document.querySelector(".effect-level"),t=e.querySelector(".effect-level__line"),o=e.querySelector(".effect-level__depth"),n=e.querySelector(".effect-level__pin"),r=[];n.addEventListener("mousedown",(e=>{e.preventDefault(),n.focus();let o=e.clientX;const r=e=>{e.preventDefault();const r=o-e.clientX;o=e.clientX;const s=n.offsetLeft-r;if(s>=0&&s<=t.clientWidth){const e=Math.round(s/t.clientWidth*100);l(e)}},s=e=>{e.preventDefault(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",s)})),n.addEventListener("keydown",(e=>{e.code===window.helpers.LEFT&&(e.preventDefault(),s()>0&&l(s()-1)),e.code===window.helpers.RIGHT&&(e.preventDefault(),s()<100&&l(s()+1))}));const s=()=>Math.round(n.offsetLeft/t.clientWidth*100),l=e=>{n.style.left=e+"%",o.style.width=e+"%",r.forEach((t=>t(e)))};window.slider={show:()=>{e.style.display="block"},hide:()=>{e.style.display="none"},change:(e,t)=>{r.push(t)},setValue:l}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=100,o=document.querySelector(".img-upload__form"),n=o.querySelector(".img-upload__overlay"),r=o.querySelector(".img-upload__cancel"),s=n.querySelector(".img-upload__preview img"),l=document.querySelector(".effect-level__value"),c=o.querySelector(".text__hashtags"),i=document.querySelector(".text__description"),a=o.querySelector("#effect-none"),d=document.querySelector("main"),u=n.querySelectorAll(".effects__preview");let m="none";const w=e=>{m=e,v(),s.classList.add("effects__preview--"+e),"none"===e?window.slider.hide():window.slider.show(),p(m)},v=()=>{const e=s.classList;e.forEach((t=>{t.startsWith("effects__preview--")&&e.remove(t)}))},p=e=>{const o={chrome:`grayscale(${l.value/t})`,sepia:`sepia(${l.value/t})`,marvin:`invert(${l.value}%)`,phobos:`blur(${3*l.value/t}px)`,heat:`brightness(${3*l.value/t+1})`,default:""};s.style.filter=o[e]||o.default};o.addEventListener("change",(e=>{e.target&&e.target.matches(".effects__radio")&&w(e.target.value)})),window.slider.change("change",(e=>{l.value=e,p(m)}));const y=()=>{n.classList.add("hidden"),window.main.body.classList.remove("modal-open"),window.removeEventListener("keydown",h),o.reset()};r.addEventListener("click",(e=>{e.preventDefault(),y()}));const h=e=>{c!==document.activeElement&&i!==document.activeElement&&e.key===window.helpers.ESC&&(e.preventDefault(),y())},f=document.querySelector(".img-upload__scale"),_=f.querySelector(".scale__control--smaller"),g=f.querySelector(".scale__control--bigger"),S=f.querySelector(".scale__control--value");let E=t;_.addEventListener("click",(e=>{e.preventDefault(),25<E&&(E-=25,s.style.transform=`scale(${E/t})`,S.value=E+"%")})),g.addEventListener("click",(e=>{e.preventDefault(),E<t&&(E+=25,s.style.transform=`scale(${E/t})`,S.value=E+"%")})),c.addEventListener("input",(()=>{const e=window.hashtagsValidity.check(c.value);c.setCustomValidity(e),c.reportValidity()})),i.addEventListener("input",(()=>{const e=window.commentValidity.check(i.value);i.setCustomValidity(e),i.reportValidity()}));const L=e=>{const t=document.querySelector("#"+e).content.querySelector("."+e).cloneNode(!0),o=t.querySelector(`.${e}__button`);d.appendChild(t);const n=e=>{e.preventDefault(),e.stopPropagation(),d.removeChild(t),window.removeEventListener("keydown",r)},r=e=>{e.key===window.helpers.ESC&&(e.preventDefault(),d.removeChild(t),window.removeEventListener("keydown",r))};window.addEventListener("keydown",r),o.addEventListener("click",n),t.addEventListener("click",n)};o.addEventListener("submit",(e=>{window.backend.request({onSuccess:()=>{y(),L("success")},onError:()=>{y(),L("error")},url:"https://21.javascript.pages.academy/kekstagram",method:"POST",data:new FormData(o)}),e.preventDefault()})),window.editForm={open:()=>{const o=window.main.uploadPhotoButton.files[0],r=o.name.toLowerCase();if(e.some((e=>r.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{window.editForm.preview.src=e.result,u.forEach((t=>{t.style.backgroundImage=`url(${e.result})`}))})),e.readAsDataURL(o),n.classList.remove("hidden"),window.main.body.classList.add("modal-open"),window.addEventListener("keydown",h),w("none"),a.checked=!0,E=t,S.value="100%",s.style.transform="scale(1)",window.slider.setValue(t),c.setCustomValidity(""),i.setCustomValidity("")}},preview:s}})(),(()=>{const e=document.querySelector("body"),t=document.querySelector("#upload-file"),o=document.querySelector(".error-banner");let n=[];const r=e=>{n=e.slice(),window.gallery.render(n)};window.backend.request({onSuccess:e=>{n=e,r(e),window.filters.init(r,n)},onError:e=>{o.style.display="block",o.textContent=e},url:"https://21.javascript.pages.academy/kekstagram/data",method:"GET"}),t.addEventListener("change",(e=>{e.preventDefault(),window.editForm.open()})),window.main={body:e,uploadPhotoButton:t}})()})();